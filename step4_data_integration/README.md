\# Step 4: データ統合・照合



3つの異なるデータソースを管理番号で統合し、照合用のExcelファイルを生成します。



\## 機能



\- ✅ 複数データソース（Excel A、スプレッドシート、Excel B）の統合

\- ✅ 管理番号による自動マッチング

\- ✅ カラム名の自動リネーム（データソース別プレフィックス付与）

\- ✅ マルチレベルヘッダー付きExcel出力

\- ✅ データソース別の色分け

\- ✅ 自動列幅調整

\- ✅ ウィンドウ枠固定



\## 実行環境



\*\*Google Colab\*\* を使用します（無料で利用可能）



\### Google Colab とは？



\- Googleが提供するクラウドベースのJupyter Notebook環境

\- Pythonコードをブラウザで実行

\- 環境構築不要

\- 無料で12GBのRAMを使用可能



\## セットアップ



\### 1. Google Colab でノートブックを開く



1\. \[Google Colab](https://colab.research.google.com/) にアクセス

2\. 「ファイル」→「ノートブックを開く」→「GitHub」タブ

3\. このリポジトリのURL を入力

4\. `integrate\_data.ipynb` を選択



または：



1\. このリポジトリの `integrate\_data.ipynb` をダウンロード

2\. Google Colab で「ファイル」→「ノートブックをアップロード」



\### 2. スプレッドシートURLを設定



ノートブック内の設定セルを編集：

```python

SPREADSHEET\_URL = 'https://docs.google.com/spreadsheets/d/YOUR\_SPREADSHEET\_ID/edit'

SHEET\_NAME\_SS = "Data"

```



\### 3. 実行方法



1\. 「ランタイム」→「すべてのセルを実行」

2\. Google認証を求められるので承認

3\. ファイルアップロード画面が表示される

4\. エクセルA（請求明細情報）をアップロード

5\. エクセルB（進捗表）をアップロード

6\. 処理完了後、統合ファイルが自動ダウンロードされる



\## 処理フロー

```

入力:

&nbsp; ├─ Excel A（請求明細情報）

&nbsp; ├─ スプレッドシート（Step 3の集約データ）

&nbsp; └─ Excel B（進捗表）

&nbsp;      ↓

管理番号による Left Join

&nbsp;      ↓

カラム名にプレフィックス追加

&nbsp; ├─ \_\_A\_\_ (Excel A由来)

&nbsp; ├─ \_\_SS\_\_ (スプレッドシート由来)

&nbsp; └─ \_\_B\_\_ (Excel B由来)

&nbsp;      ↓

マルチレベルヘッダー作成

&nbsp;      ↓

Excel出力（色分け・列幅調整済み）

```



\## 出力ファイル



\### ファイル名

`統合データ\_請求明細\_進捗.xlsx`



\### 構造



\*\*1行目\*\*: データソース名（色分け）

\- 🔵 青系: 請求明細情報（Excel A）

\- 🟢 緑系: スプレッドシート

\- 🟡 黄系: 進捗表（Excel B）



\*\*2行目\*\*: 列名



\*\*3行目以降\*\*: データ



\### 特徴



\- ✅ ウィンドウ枠固定（上2行・左は管理番号列まで）

\- ✅ 自動列幅調整

\- ✅ 日付形式の統一（YYYY/MM/DD）

\- ✅ データソース別の色分け



\## 統合キーのカスタマイズ



デフォルトでは「管理番号」で統合しますが、別のキーを使用する場合：

```python

\# 管理番号 → カスタムキーに変更

df\_merged = pd.merge(df\_a, df\_gs, on='カスタムキー', how='left')

```



\## トラブルシューティング



\### Google認証エラー

```python

\# 認証セルを再実行

auth.authenticate\_user()

creds, \_ = default()

gc = gspread.authorize(creds)

```



\### スプレッドシートが見つからない



\- URLが正しいか確認

\- スプレッドシートの共有設定を確認（リンクを知っている全員が閲覧可能）



\### メモリエラー



\- 処理するデータ量が多すぎる可能性

\- 不要な列を事前に削除

\- データを分割して処理



\### ファイルがダウンロードされない



\- ポップアップブロッカーを無効化

\- 手動でダウンロード:

```python

&nbsp; files.download(output\_filename)

```



\## 依存ライブラリ



`requirements.txt` に記載：

```

pandas>=2.0.0

gspread>=5.0.0

google-auth>=2.0.0

xlsxwriter>=3.0.0

openpyxl>=3.1.0

```



\## 実行時間の目安



| データ量 | 実行時間 |

|---------|---------|

| 100行 × 3ソース | 10-20秒 |

| 1,000行 × 3ソース | 30-60秒 |

| 10,000行 × 3ソース | 2-5分 |



\## 次のステップ



出力されたExcelファイルを使用して：

\- データの照合作業

\- 不一致項目の確認

\- レポート作成

